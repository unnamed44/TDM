<html>
<head>
	<title> Test ui</title>
	<link rel="stylesheet" href="main.css" />
	<script>

	var previousDps = ''
	var TDMSettings
	var agree = false
	var waitForThis = false
	var slog = []
	var skillInfo = []
	var 	_name = ''
	var	classId = ''

	// manager ui
	function manager_ajax(url, cb) {
		var x = new XMLHttpRequest();
		pending = true;
		x.open("GET", "manager/" + url, true);
		x.onload = cb;
		x.send();
		return;
	}
	function onClick(val)
	{
		manager_ajax(val,null)
	}
	function ManagerCB()
	{
		document.getElementById("manager").innerHTML = this.responseText.substring(1, this.responseText.length - 1)
	}
	function Manager()
	{
		manager_ajax("R",ManagerCB)
	}

	// TDM ui
	function ajax(url, cb) {
		var x = new XMLHttpRequest();
		pending = true;
		x.open("GET", "api/" + url, true);
		x.onload = cb;
		x.send();
		return;
	}


	function stripOuterHTML(str) {
		return str.replace(/\'|^<[^>]+>|<\/[^>]+><[^\/][^>]*>|<\/[^>]+>$/g, '')
	}

	String.prototype.color = function (hexColor) {
		return '<font color="#' +hexColor+'">'+ this +'</font>'
	}


	function Clipboard() {
		var copyText = document.getElementById("txt");
		copyText.select();
		document.execCommand("copy");
	}

	function validate(evt) {
		var theEvent = evt || window.event;
		var key = theEvent.keyCode || theEvent.which;
		key = String.fromCharCode( key );
		var regex = /[0-9]|\./;
		if( !regex.test(key) ) {
			theEvent.returnValue = false;
			if(theEvent.preventDefault) theEvent.preventDefault();
		}
	}


	function warningMsg()
	{
		if(agree) return true
		if(typeof _tera_client_proxy_ !== 'undefined') {
			_tera_client_proxy_.alert("Please remember TDM is not for mocking others. It is at your own risk to get banned by sending dps data. Press again if you agree with this.");
		}
		agree = true
		return false
	}

	function Whisper() {
		if(!warningMsg()) return
		var n = document.getElementById("name").value;
		ajax("0W"+ n,null)
	}

	function ToGuild() {
		if(!warningMsg()) return
		ajax("2C",null)
	}

	function ToParty() {
		if(!warningMsg()) return
		ajax("1C",null)
	}

	function LeaveParty() {
		ajax("L",null)
	}

	function Reset() {
		ajax("100S",null)
	}
	function CloseDpsCB() {
		if(typeof _tera_client_proxy_ !== 'undefined') {
			_tera_client_proxy_.close()
		}
	}
	function CloseDps() {
		ajax("P",CloseDpsCB)
	}

	// settings
	function NoticeDamageAdd() {
		ajax("A",Settings)
	}

	function Debug() {
		ajax("B",Settings)
	}

	function Notice() {
		ajax("N",Settings)
	}

	function AllUsers() {
		ajax("U",Settings)
	}
	function BossOnly() {
		ajax("O", Settings)
	}
	function HideNames()
	{
		ajax("I",Settings)
	}
	function SkillLog()
	{
		ajax("1L",Settings)
	}
	function RankSystem()
	{
		ajax("2R",Settings)
	}
	function ReloadTDM()
	{
		ajax("X",refreshCB)
	}

	function UpdateCB()
	{
		var dpsmsg = this.responseText.substring(1, this.responseText.length - 1)
		document.getElementById("content").innerHTML = dpsmsg.replace(/(\\n|\\)/gm,"");
	}
	function Update()
	{
		waitForThis = true
		ajax("Q",UpdateCB)
	}

	function openweb(e) {
		//_tera_client_proxy_.alert("TDM does not support details of skill info yet.");
	}


	// history tab
	function HistoryCB() {
		var res = JSON.parse(this.responseText)
		if(res === '') return
		var result = ''
		for(var key in res){
			result += tableDPSFormat(res[key])
		}
		document.getElementById("history").innerHTML = result;
	}

	function History() {
		ajax("H",HistoryCB)
	}


	// setting tab
	function SettingsCB()
	{
		TDMSettings = JSON.parse(this.responseText)
		document.getElementById("NoticeDamageAdd").innerHTML = TDMSettings.noticeDamage
		document.getElementById("Notice").innerHTML = TDMSettings.notice
		document.getElementById("BossOnly").innerHTML = TDMSettings.bossOnly
		document.getElementById("HideNames").innerHTML = TDMSettings.hideNames
		document.getElementById("SkillLog").innerHTML = TDMSettings.skillLog
		document.getElementById("RankSystem").innerHTML = TDMSettings.rankSystem
		document.getElementById("AllUsers").innerHTML = TDMSettings.allUsers
		document.getElementById("Debug").innerHTML = TDMSettings.debug
		document.getElementById("debug").innerHTML = 'party:'+ TDMSettings.partyLengh + '| NPCs:' + TDMSettings.NPCsLength + '| BAMHistory:' + TDMSettings.BAMHistoryLength
	}

	function Settings(){
		ajax("Y",SettingsCB)
	}

	// dps tab
	function DPS(){

	}

	// Custom tab
	function excuteCCmd(evt,cmd)
	{
		//document.getElementById("debug").innerHTML = cmd
		ajax("4C"+cmd,null)
	}

	function CustomCB()
	{
		var data = JSON.parse(this.responseText)
		var html = ''
		//'<table><tr><td>'
		for(var key in data){
			html += '<button class=btn onclick="excuteCCmd(event,\''+ key +'\')">' + data[key] + '</button><br>'
		}
		//document.getElementById("debug").innerHTML = html
		document.getElementById("custom").innerHTML = html
	}

	function Custom(){
		ajax("3C",CustomCB)
	}

	function getVersionCB()
	{
		var c = JSON.parse(this.responseText)
		document.getElementById("version").innerHTML = c[0]
	}

	function getVersion()
	{
		ajax("V",getVersionCB)
	}

	function ExtUICB()
	{
		console.log(this.responseText)
		var c = JSON.parse(this.responseText)
		openWebsite('http://' + c.host + ':'+ c.port)
		CloseDps()
	}

	function ExtUI()
	{
		ajax("E",ExtUICB)
	}

	function numberWithCommas(x) {
		return x.replace(/\B(?=(\d{3})+(?!\d))/g, ",")
	}
	/*
	000,000 => 000 k
	0,000,000 => 0,000 k
	000,000,000 => 000,000 k
	0,000,000,000 => 0,000 m*/
	function unitDps(dps)
	{
		if(dps.length <= 5) return numberWithCommas(dps) + '/s'.color('E69F00')
		if(dps.length > 5 && dps.length < 10) {
			 var kdps= dps.substring(0, dps.length - 3)
			 return numberWithCommas(kdps) + 'k/s'.color('E69F00')
		}
		if(dps.length >= 10) {
			var mdps= dps.substring(0, dps.length - 6)
			return numberWithCommas(mdps) + 'm/s'.color('E69F00')
		}
	}

	function unitDmg(dps)
	{
		if(dps.length <= 5) return numberWithCommas(dps)
		if(dps.length > 5 && dps.length < 10) {
			 var kdps= dps.substring(0, dps.length - 3)
			 return numberWithCommas(kdps) + 'k'.color('E69F00')
		}
		if(dps.length >= 10) {
			var mdps= dps.substring(0, dps.length - 6)
			return numberWithCommas(mdps) + 'm'.color('E69F00')
		}
	}

	function BigInt(n)
	{
		return Number(n)
	}

	function binarySearchSkillName(d, t, s , e)
	{
		const m = Math.floor((s + e)/2);
		var target = Number(t)
		var id = Number(d[m].id)
		if (target == id) return d[m].skillName;
		if (e - 1 == s) return 'undefined'
	  	if (target > id) return binarySearchSkillName(d,t,m,e);
	  	if (target < id) return binarySearchSkillName(d,t,s,m);
	}

	function skillIdToName(id)
	{
		if(skillInfo.length == 0) return 'skill tsv missing'
		var sid = id.slice(1,id.length)
		return binarySearchSkillName(skillInfo, sid, 0, skillInfo.length - 1)
		/*for(var i in skillInfo)
		{
			if(skillInfo[i].id === sid)
				return skillInfo[i].skillName
		}*/
	}

	function dpsStastic()
	{
		var s= []

		// set skill name
		for (var i in slog)
		{
			slog[i]['name'] = skillIdToName(slog[i].skillId)
		}

		for(var i in slog)
		{
			var t=slog[i]
			var id = t.skillId
			var name = t.name
			var damage = BigInt(t.damage)
			var c = t.crit

			var found = false
			// search skill id and insert data
			for (var j in s)
			{
				if(s[j].name === name)
				{
					s[j].wDamage = c ? s[j].wDamage : BigInt(s[j].wDamage) + damage
					s[j].rDamage = c ? BigInt(s[j].rDamage) + damage : s[j].rDamage

					//console.log( s[j].wDamage + ' ' + s[j].wDamage)
					found = true
					break
				}
			}

			// not found push a new entity
			if(!found){
				var d = {
					'name' : name,
					'wDamage' : c ? BigInt(0) : (damage),
					'rDamage' : c ? (damage) : BigInt(0)
				}

				s.push(d)
				//console.log('pushed ' + id)
			}
		}
		//console.log(s)
		// sort by total damage
		s.sort(function(a,b) {

			a["tDamage"]= a.wDamage + a.rDamage
			if(typeof b["tDamage"] === 'undefined')b["tDamage"]= b.wDamage + b.rDamage

			if(a.wDamage + a.rDamage > b.wDamage + b.rDamage) return -1
			else if(a.wDamage + a.rDamage < b.wDamage + b.rDamage) return 1
			else return 0
		})

		var html='<button class="btn" onclick="refreshDPS()">return to DPS</button><button class="btn" onclick="skillLog(\''+_name+'\',\''+classId+'\')">Skill Log</button><br>'

		html += '<table><tr><td>Skill Name</td><td>White Dmg</td><td>Red Dmg</td><td>Total Dmg</td></tr>'
		for(var i in s){
				var t = s[i].wDamage + s[i].rDamage
				html+='<tr>'
				html+='<td>' + s[i].name + '</td>'
				html+='<td>' +unitDmg(s[i].wDamage.toString()) + '</td>'
				html+='<td>' +unitDmg(s[i].rDamage.toString()) + '</td>'
				html+='<td>' +unitDmg(s[i].tDamage.toString()) + '</td>'
				html+='</tr>'
		}
		html+='</table>'
		document.getElementById("content").innerHTML = html

	}

	function skillLogCB()
	{
		slog = []
		slog = JSON.parse(this.responseText)
		//console.log(slog)
		var html='<button class="btn" onclick="refreshDPS()">return to DPS</button><button class="btn" onclick="dpsStastic()">Stastic</button><br>'
		html += '<table><tr><td>Time</td><td>skill ID</td><td>Damage</td><td>Crit</td></tr>'
		for(var i in slog){
				html+='<tr>'
				html+='<td>' +(new Date(slog[i].Time)).toTimeString().slice(0,8)+ '</td>'
				html+='<td>' +skillIdToName(slog[i].skillId)+ '</td>'
				html+='<td>' +slog[i].damage+ '</td>'
				html+='<td>' +slog[i].crit+ '</td>'
				html+='</tr>'
		}
		html+='</table>'
		document.getElementById("content").innerHTML = html
	}

	function getSkillInfoCB()
	{
		skillInfo = []
		skillInfo = JSON.parse(this.responseText)
	}

	function skillLog(n,c)
	{
		_name = n
		classId = c
		waitForThis = true
		if(skillInfo.length == 0) ajax(c+"S",getSkillInfoCB)
		ajax("2L"+n,skillLogCB)
	}

	function classIdToName(id)
	{
		if(id == 0) return 'Warrior'
		if(id == 1) return 'Lancer'
		if(id == 2) return 'Slayer'
		if(id == 3) return 'Berserker'
		if(id == 4) return 'Sorcerer'
		if(id == 5) return 'Archer'
		if(id == 6) return 'Priest'
		if(id == 7) return 'Mystic'
		if(id == 8) return 'Reaper'
		if(id == 9) return 'Gunner'
		if(id == 10) return 'Brawler'
		if(id == 11) return 'Ninja'
		if(id == 12) return 'Valkyrie'
		return ''
	}

	function tableDPSFormat(data)
	{
		var dpsmsg = ''
		var enragedBar = 0

		dpsmsg += '<table>'

		for(var i in data){
			if(data[i].hasOwnProperty('monsterBattleInfo')) {
				if(data[i].etimer > 0)
				{
					enragedBar = data[i].etimer * 100 / 36
					dpsmsg += '<tr><th colspan="4" style="background: url(\'./icons/enraged_bar.jpg\'); background-repeat: no-repeat; background-size: ' + enragedBar +'% 10%;">'
				}
				else {
					enragedBar = data[i].eCountdown * 10
					dpsmsg += '<tr><th colspan="4" style="background: url(\'./icons/bar.jpg\'); background-repeat: no-repeat; background-size: ' + enragedBar +'% 10%;">'
				}

				dpsmsg += data[i].enraged
				dpsmsg += '<br>' + data[i].monsterBattleInfo + '</th></tr>'
				continue
			}
			dpsmsg 	+='<tr><td> ' + data[i].name
					+ '<img onclick="skillLog(\''+ stripOuterHTML(data[i].name) +'\', '+data[i].class+')" src="./class-icons/'+classIdToName(data[i].class).toLowerCase()+'.png' +'" />'
					+ ' </td>' + '<td style="background: url(\'./icons/bar.jpg\'); background-repeat: no-repeat; background-size: '+data[i].percentage+'% 20%;">'
					+ unitDps(data[i].dps) + ' </td>'
					+ '<td> ' + data[i].percentage  + '%'.color('E69F00') + ' </td>'
					+ '<td> ' +  data[i].crit  + '%'.color('E69F00') + ' </td></tr>'
		}
		dpsmsg += '</table>'
		return dpsmsg
	}

	function refreshCB()
	{
		skillInfo = []
		var res = JSON.parse(this.responseText)

		//document.getElementById("debug").innerHTML = this.responseText;

		if(res === '') return
		var result = tableDPSFormat(res)
		if(result === previousDps) return
		if(waitForThis == true) return
		document.getElementById("content").innerHTML = result + '<br>'

		previousDps = result

	}

	function refreshDPS()
	{
		previousDps = 'NEW'
		waitForThis = false
		var i = setInterval(function(){
			if(waitForThis){
				clearInterval(i);
				return
			}
			ajax("R",refreshCB)
		}, 1000);
	}

	window.addEventListener('error', function(e) {
		if(typeof _tera_client_proxy_ !== 'undefined') {
			_tera_client_proxy_.alert('Error: ' + e.message)
		}
	})

	window.onbeforeunload =  function() {
		//ajax("P",CloseDpsCB)
		return null;
	}

	function setStyleCB()
	{

		document.getElementById("debug").innerHTML = this.responseText
		var data = this.responseText.substring(1, this.responseText.length - 1)
		var size = data.split(',')
		if(typeof _tera_client_proxy_ !== 'undefined') {
			_tera_client_proxy_.resize_to(Number(size[0]), Number(size[1]))
		}
		var divhight = 'height:' + (Number(size[1]) - 55) + 'px'
		document.getElementById('content').setAttribute("style",divhight);
		var wrapperdivhight = 'height:' + size[1] + 'px'
		document.getElementById('wrapper').setAttribute("style",wrapperdivhight);
		document.getElementById('history').setAttribute("style",divhight);
		document.getElementById('settings').setAttribute("style",divhight);
		document.getElementById('wrapper').style.display = "block";


	}

	function readConfig()
	{
		ajax("Z",setStyleCB)
	}

	function useBrowser(url)
	{
		if(typeof _tera_client_proxy_ !== 'undefined') {
			_tera_client_proxy_.resize_to(1024, 768)
		}
		window.location.href=url
	}

	function useBrowserHelp()
	{
		var locale = ''
		if(typeof _tera_client_proxy_ !== 'undefined') {
			locale = _tera_client_proxy_.get_locale()
		}
		//_tera_client_proxy_.alert(locale);
		var url = ''
		if(locale === 'kr') url = './README_KR.html'
		else url = './README.html'
		if(typeof _tera_client_proxy_ !== 'undefined') {
			_tera_client_proxy_.resize_to(1024, 768)
		}
		window.location.href=url
	}
	function openWebsite(url)
	{
		if(typeof _tera_client_proxy_ !== 'undefined') {
			_tera_client_proxy_.open_web_direct(url)
		}
		else{
			window.location.href=url
		}
	}

	function openTab(evt, tabName) {
	    var i, tabcontent, tablinks;
	    tabcontent = document.getElementsByClassName("tabcontent");
	    for (i = 0; i < tabcontent.length; i++) {
	        tabcontent[i].style.display = "none";
	    }
	    tablinks = document.getElementsByClassName("tablinks");
	    for (i = 0; i < tablinks.length; i++) {
	        tablinks[i].className = tablinks[i].className.replace(" active", "");
	    }
	    document.getElementById(tabName).style.display = "block";
	    if(evt != null)evt.currentTarget.className += " active";

	    if(tabName === 'wrapper') DPS()
	    if(tabName === 'history') History()
	    if(tabName === 'settings') Settings()
	    if(tabName === 'custom') Custom()
	    if(tabName === 'manager') Manager()
	}

	function nullClientProxy () {
	    this.set_title = function (t){
		    document.title = t
	    }
	    function alert(m) {alert(m)}
	    this.get_locale = function() {}
	    this.open_web_direct = function (url){
		    window.location.href=url
	    }
	    this.close = 0;
	}

	window.onload = function() {

		if(typeof _tera_client_proxy_ !== 'undefined') {
			_tera_client_proxy_.resize_to(320, 250)
			_tera_client_proxy_.set_title('Tera DPS Monitor')
		}
		readConfig()
		refreshDPS()
		getVersion()
	}

	</script>
</head>
<body>
	<div class="tab">
		<button class="tablinks active" onclick="openTab(event,'wrapper')">DPS</button>
		<button class="tablinks" onclick="openTab(event,'history')">History</button>
		<button class="tablinks"  onclick="openTab(event,'settings')">Settings</button>
		<button class="tablinks" onclick="ExtUI()">ExtUI</button>
		<button class="tablinks" onclick="CloseDps()">Close</button>
	</div>
	<div  id="wrapper" class="tabcontent">
		<div  id="content">
		</div >
		<input class=ipt type="text" size="1" id="name" value="">
		<button class=btn onclick="Whisper()">Whisper</button>
		<button class=btn onclick="ToParty()">ToParty</button>
		<button class=btn onclick="ToGuild()">ToGuild</button>
		<button class=btn onclick="LeaveParty()">LeaveParty</button>
		<button class=btn onclick="Reset()">Reset</button><br>
		<p id="version"></p>
		<div  id="skillLog">
		</div >
	</div>
	<div  id="history" class="tabcontent">
	</div>
	<div  id="custom" class="tabcontent">
	</div>
	<div  id="manager" class="tabcontent">
	</div>
	<div  id="settings" class="tabcontent">
		<div id='status'>
		</div>
		<button class=btn onclick="Update()">Update TDM</button>
		<button class=btn onclick="useBrowser('http://tera.dvcoa.com.au:3000')"> Rank System</button>
		<button class=btn onclick="openWebsite('https://discord.gg/JRa7FXd')">TDM Discord</button>
		<br>
		<button class=btn onclick="openWebsite('https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=C6BU555NMQJD6')">Donate to dev</button>
		<button class=btn onclick="useBrowser('https://www.gnu.org/licenses/gpl-3.0-standalone.html')">LICENSE</button>
		<button class=btn onclick="useBrowserHelp()">Usage</button>
		<br><br>
		<table>
			<tr>
				<td><button class=btn onclick="NoticeDamageAdd()">Notice value</button></td><td><p id="NoticeDamageAdd"></p></td>
				<td><button class=btn onclick="Notice()">Notice</button></td><td><p id="Notice"></p></td>
			</tr>
			<tr>
				<td><button class=btn onclick="BossOnly()">bossOnly</button></td><td><p id="BossOnly"></p></td>
				<td><button class=btn onclick="HideNames()">HideNames</button></td><td><p id="HideNames"></p></td>
			</tr>
			<tr>
				<td><button class=btn onclick="RankSystem()">SendDataTo</button></td><td><p id="RankSystem"></p></td>
				<td><button class=btn onclick="AllUsers()">All DPS</button><br></td><td><p id="AllUsers"></p></td>
			</tr>
			<tr>
				<td><button class=btn onclick="SkillLog()">SkillLog</button></td><td><p id="SkillLog"></p></td>
				<td><button class=btn onclick="Debug()">Debug</button></td><td><p id="Debug"></p></td>
			</tr>
		</table>
		<br><br>
		<button class=btn onclick="openTab(event,'manager')">Module Manager</button><button class=btn onclick="openTab(event,'custom')">Custom Commands</button><br>
		<br><br><br><br><br><br><br><br>
		<br><br><br><br><br><br><br><br>
		<textarea id="debug" maxLength="2000" rows="14" cols="50" style="background-color: #2E3440;"></textarea>
		<div style="position:relative;width:267px;height:25px;overflow:hidden;">
			<div style="position:absolute;top:-276px;left:-5px">
				<iframe width="300" height="300"
				src="https://www.youtube.com/embed/9Ugfve_qx-s?rel=0">
			</iframe>
			</div>
		</div>
	</div>
</body>
</html>
