<html>
<head>
	<title> Test ui</title>
	<link rel="stylesheet" href="main.css" />
	<script>

	var previousDps = ''
	var TDMSettings
	var agree = false
	var waitForThis = false

	// manager ui
	function manager_ajax(url, cb) {
		var x = new XMLHttpRequest();
		pending = true;
		x.open("GET", "manager/" + url, true);
		x.onload = cb;
		x.send();
		return;
	}
	function onClick(val)
	{
		manager_ajax(val,null)
	}
	function ManagerCB()
	{
		document.getElementById("manager").innerHTML = this.responseText.substring(1, this.responseText.length - 1)
	}
	function Manager()
	{
		manager_ajax("R",ManagerCB)
	}

	// TDM ui
	function ajax(url, cb) {
		var x = new XMLHttpRequest();
		pending = true;
		x.open("GET", "api/" + url, true);
		x.onload = cb;
		x.send();
		return;
	}


	function stripOuterHTML(str) {
		return str.replace(/\'|^<[^>]+>|<\/[^>]+><[^\/][^>]*>|<\/[^>]+>$/g, '')
	}

	String.prototype.clr = function (hexColor) {
		return '<font color="#' +hexColor+'">'+ this +'</font>'
	}


	function Clipboard() {
		var copyText = document.getElementById("txt");
		copyText.select();
		document.execCommand("copy");
	}

	function validate(evt) {
		var theEvent = evt || window.event;
		var key = theEvent.keyCode || theEvent.which;
		key = String.fromCharCode( key );
		var regex = /[0-9]|\./;
		if( !regex.test(key) ) {
			theEvent.returnValue = false;
			if(theEvent.preventDefault) theEvent.preventDefault();
		}
	}


	function warningMsg()
	{
		if(agree) return true
		_tera_client_proxy_.alert("Please remember TDM is not for mocking others. It is at your own risk to get banned by sending dps data. Press again if you agree with this.");
		agree = true
		return false
	}

	function Whisper() {
		if(!warningMsg()) return
		var name = document.getElementById("name").value;
		ajax("0W"+ name,null)
	}

	function ToGuild() {
		if(!warningMsg()) return
		ajax("2C",null)
	}

	function ToParty() {
		if(!warningMsg()) return
		ajax("1C",null)
	}

	function LeaveParty() {
		ajax("L",null)
	}

	function Reset() {
		ajax("S",null)
	}
	function CloseDpsCB() {
		_tera_client_proxy_.close()
	}
	function CloseDps() {
		ajax("P",CloseDpsCB)
	}

	// settings
	function NoticeDamageAdd() {
		ajax("A",Settings)
	}

	function Debug() {
		ajax("B",Settings)
	}

	function Notice() {
		ajax("N",Settings)
	}

	function AllUsers() {
		ajax("U",Settings)
	}
	function BossOnly() {
		ajax("O", Settings)
	}
	function HideNames()
	{
		ajax("I",Settings)
	}

	function RankSystem()
	{
		ajax("2R",Settings)
	}
	function ReloadTDM()
	{
		ajax("X",refreshCB)
	}

	function UpdateCB()
	{
		var dpsmsg = this.responseText.substring(1, this.responseText.length - 1)
		document.getElementById("content").innerHTML = dpsmsg.replace(/(\\n|\\)/gm,"");
	}
	function Update()
	{
		ajax("Q",UpdateCB)
	}

	function openweb(e) {
		//_tera_client_proxy_.alert("TDM does not support details of skill info yet.");
	}


	// history tab
	function HistoryCB() {
		var res = JSON.parse(this.responseText)
		if(res === '') return
		var result = ''
		for(var key in res){
			result += tableDPSFormat(res[key])
		}
		document.getElementById("history").innerHTML = result;
	}

	function History() {
		ajax("H",HistoryCB)
	}


	// setting tab
	function SettingsCB()
	{
		TDMSettings = JSON.parse(this.responseText)
		document.getElementById("NoticeDamageAdd").innerHTML = TDMSettings.noticeDamage
		document.getElementById("Notice").innerHTML = TDMSettings.notice
		document.getElementById("BossOnly").innerHTML = TDMSettings.bossOnly
		document.getElementById("HideNames").innerHTML = TDMSettings.hideNames
		document.getElementById("RankSystem").innerHTML = TDMSettings.rankSystem
		document.getElementById("AllUsers").innerHTML = TDMSettings.allUsers
		document.getElementById("Debug").innerHTML = TDMSettings.debug
		document.getElementById("debug").innerHTML = 'party:'+ TDMSettings.partyLengh + '| NPCs:' + TDMSettings.NPCsLength + '| BAMHistory:' + TDMSettings.BAMHistoryLength
	}

	function Settings(){
		ajax("Y",SettingsCB)
	}

	// dps tab
	function DPS(){

	}

	// Custom tab
	function excuteCCmd(evt,cmd)
	{
		//document.getElementById("debug").innerHTML = cmd
		ajax("4C"+cmd,null)
	}

	function CustomCB()
	{
		var data = JSON.parse(this.responseText)
		var html = ''
		//'<table><tr><td>'
		for(var key in data){
			html += '<button class=btn onclick="excuteCCmd(event,\''+ key +'\')">' + data[key] + '</button><br>'
		}
		//document.getElementById("debug").innerHTML = html
		document.getElementById("custom").innerHTML = html
	}

	function Custom(){
		ajax("3C",CustomCB)
	}

	function excuteCommand(c)
	{
		for (var i in c) {
			if(c[i].hasOwnProperty('command')) {
				//_tera_client_proxy_.alert(c[i].command)
				if(c[i].command === 'close') _tera_client_proxy_.close()
				if(c[i].command === 'version') document.getElementById("version").innerHTML = c[i].argument
				if(c[i].command === 'submit') {
					document.getElementById("filename").value = c[i].argument
					document.getElementById("rankForm").submit()
				}
				if(c[i].command === 'stop refresh') waitForThis=true
			}
		}
	}

	function numberWithCommas(x) {
		return x.replace(/\B(?=(\d{3})+(?!\d))/g, ",")
	}
/*	0
	00
	000
	000,0
	000,00
	000,000 => 000 k
	0,000,000 => 0,000 k
	000,000,000 => 000,000 k
	0,000,000,000 => 0,000 m*/

	function unitDps(dps)
	{
		if(dps.length <= 5) return numberWithCommas(dps) + '/s'.clr('E69F00')
		if(dps.length > 5 && dps.length < 10) {
			 var kdps= dps.substring(0, dps.length - 3)
			 return numberWithCommas(kdps) + 'k/s'.clr('E69F00')
		}
		if(dps.length >= 10) {
			var mdps= dps.substring(0, dps.length - 6)
			return numberWithCommas(mdps) + 'm/s'.clr('E69F00')
		}
	}

	function tableDPSFormat(data)
	{
		var dpsmsg = ''
		var c
		var enragedBar = 0

		dpsmsg += '<table>'

		for(var i in data){
			if(data[i].hasOwnProperty('monsterBattleInfo')) {
				if(data[i].etimer > 0) enragedBar = data[i].etimer * 100 / 36
				dpsmsg += '<tr><th colspan="4" style="background: url(\'./icons/enraged_bar.jpg\'); background-repeat: no-repeat; background-size: ' + enragedBar +'% 10%;">'
				dpsmsg += data[i].enraged
				dpsmsg += '<br>' + data[i].monsterBattleInfo + '</th></tr>'
				continue
			}
			if(data[i].hasOwnProperty('command')) {
				c=i
				continue
			}
			dpsmsg 	+='<tr><td> ' + data[i].name  + ' </td>' + '<td style="background: url(\'./icons/bar.jpg\'); background-repeat: no-repeat; background-size: '+data[i].percentage+'% 20%;">'
					+ unitDps(data[i].dps) + ' </td>'
					+ '<td> ' + data[i].percentage  + '%'.clr('E69F00') + ' </td>'
					+ '<td class=graph> ' +  data[i].crit  + '%'.clr('E69F00') + ' </td></tr>'
		}
		dpsmsg += '</table>'
		if( c != null ) excuteCommand(data)
		return dpsmsg
	}

	function refreshCB()
	{
		var res = JSON.parse(this.responseText)

		//document.getElementById("debug").innerHTML = this.responseText;

		if(res === '') return
		var result = tableDPSFormat(res)
		if(result === previousDps) return
		if(waitForThis == true) return
		document.getElementById("content").innerHTML = result + '<br>'

		previousDps = result
	}

	function refreshDPS()
	{
		//_tera_client_proxy_.alert('test')
		//waitForThis = false
		var i = setInterval(function(){
			if(waitForThis){
				clearInterval(i);
				return
			}
			ajax("R",refreshCB)
		}, 1000);
	}

	window.addEventListener('error', function(e) {
		_tera_client_proxy_.alert('Error: ' + e.message)
	})

	window.onbeforeunload =  function() {
		//ajax("P",CloseDpsCB)
		return null;
	}

	function setStyleCB()
	{
		document.getElementById("debug").innerHTML = this.responseText
		var data = this.responseText.substring(1, this.responseText.length - 1)
		var size = data.split(',')
		_tera_client_proxy_.resize_to(Number(size[0]), Number(size[1]))
		var divhight = 'height:' + (Number(size[1]) - 55) + 'px'
		document.getElementById('content').setAttribute("style",divhight);
		var wrapperdivhight = 'height:' + size[1] + 'px'
		document.getElementById('wrapper').setAttribute("style",wrapperdivhight);
		document.getElementById('history').setAttribute("style",divhight);
		document.getElementById('settings').setAttribute("style",divhight);
		document.getElementById('wrapper').style.display = "block";
	}

	function readConfig()
	{
		ajax("Z",setStyleCB)
	}

	function useBrowser(url)
	{
		_tera_client_proxy_.resize_to(1024, 768)
		window.location.href=url
	}

	function useBrowserHelp()
	{
		var locale = _tera_client_proxy_.get_locale()
		//_tera_client_proxy_.alert(locale);
		var url = ''
		if(locale === 'kr') url = './README_KR.html'
		else url = './README.html'
		_tera_client_proxy_.resize_to(1024, 768)
		window.location.href=url
	}
	function openWebsite(url)
	{
		_tera_client_proxy_.open_web_direct(url)
	}

	function openTab(evt, tabName) {
	    var i, tabcontent, tablinks;
	    tabcontent = document.getElementsByClassName("tabcontent");
	    for (i = 0; i < tabcontent.length; i++) {
	        tabcontent[i].style.display = "none";
	    }
	    tablinks = document.getElementsByClassName("tablinks");
	    for (i = 0; i < tablinks.length; i++) {
	        tablinks[i].className = tablinks[i].className.replace(" active", "");
	    }
	    document.getElementById(tabName).style.display = "block";
	    if(evt != null)evt.currentTarget.className += " active";

	    if(tabName === 'wrapper') DPS()
	    if(tabName === 'history') History()
	    if(tabName === 'settings') Settings()
	    if(tabName === 'custom') Custom()
	}


	window.onload = function() {
		_tera_client_proxy_.resize_to(320, 250)
		_tera_client_proxy_.set_title('Tera DPS Monitor')
		readConfig()
		refreshDPS()
	}

	</script>
</head>
<body>
	<div class="tab">
		<button class="tablinks active" onclick="openTab(event,'wrapper')">DPS</button>
		<button class="tablinks" onclick="openTab(event,'history')">History</button>
		<button class="tablinks"  onclick="openTab(event,'settings')">Settings</button>
		<button class="tablinks" onclick="openTab(event,'custom')">Custom</button>
		<button class="tablinks" onclick="CloseDps()">Close</button>
	</div>
	<div  id="wrapper" class="tabcontent">
		<div  id="content">
		</div >
		<input class=ipt type="text" size="1" id="name" value="">
		<button class=btn onclick="Whisper()">Whisper</button>
		<button class=btn onclick="ToParty()">ToParty</button>
		<button class=btn onclick="ToGuild()">ToGuild</button>
		<button class=btn onclick="LeaveParty()">LeaveParty</button>
		<button class=btn onclick="Reset()">Reset</button><br>
		<p id="version"></p>
	</div>
	<div  id="history" class="tabcontent">
	</div>
	<div  id="custom" class="tabcontent">
	</div>
	<div  id="settings" class="tabcontent">
		<div id='status'><br><br>
		</div>

		<table class=tablehide bordercolor="#2E3440">
			<tr><td><button class=btn onclick="NoticeDamageAdd()">Notice value</button></td><td><p id="NoticeDamageAdd"></p></td>
				<td><button class=btn onclick="Notice()">Notice</button></td><td><p id="Notice"></p></td></tr>
			<tr><td><button class=btn onclick="BossOnly()">bossOnly</button></td><td><p id="BossOnly"></p></td>
				<td><button class=btn onclick="HideNames()">HideNames</button></td><td><p id="HideNames"></p></td></tr>
			<tr><td><button class=btn onclick="RankSystem()">RankSystem</button></td><td><p id="RankSystem"></p></td>
				<td><button class=btn onclick="Update()">Update</button></td></tr>
			<tr><td><button class=btn onclick="AllUsers()">All DPS</button><br></td><td><p id="AllUsers"></p></td>
				<td><button class=btn onclick="Debug()">Debug</button></td><td><p id="Debug"></p></td></tr>
			<tr><td colspan="2"><button class=btn onclick="Manager()">Module Manager</button></td>
				<td colspan="2"><button class=btn onclick="openWebsite('https://discord.gg/JRa7FXd')">TDM Discord</button></td></tr>
			<tr><td><button class=btn onclick="openWebsite('https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=C6BU555NMQJD6')">Donate to dev</button></td><td><button class=btn onclick="useBrowser('http://tera.dvcoa.com.au:3000')">Rank</button></td>
				<td><button class=btn onclick="useBrowser('https://www.gnu.org/licenses/gpl-3.0-standalone.html')">LICENSE</button></td><td><button class=btn onclick="useBrowserHelp()">Usage</button></td></tr>
		</table>
		<br>
		<div id='manager'></div>
		<br><br><br><br><br><br><br><br>
		<div style="position:relative;width:267px;height:25px;overflow:hidden;">
			<div style="position:absolute;top:-276px;left:-5px">
				<iframe width="300" height="300"
				src="https://www.youtube.com/embed/9Ugfve_qx-s?rel=0">
			</iframe>
			</div>
		</div>
	<textarea id="debug" maxLength="2000" rows="14" cols="50"></textarea>
	<div name="my_iframe" src=""></div>
	<form id="rankForm" action="http://127.0.0.1:8080/fileupload" method="post" enctype="multipart/form-data" target="my_iframe">
		<input id="filename" type="file" name="filetoupload"><br>
		<input type="submit">
	</form>
	</div>
</body>
</html>
